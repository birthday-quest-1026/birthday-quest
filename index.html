<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Escape Room</title>
  <link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">
  <style>
    :root {
      --header-height-desktop: 88px;
      --header-height-mobile: 96px;
      --footer-h: 58px;
      --pl-pos: rgb(0, 66, 37);
      --pl-zero: rgb(74, 65, 42);
      --pl-neg: rgb(109, 3, 2);
    }
    html { -webkit-text-size-adjust: 100%; }
    body {
      font-family: 'Special Elite', monospace;
      font-size: 18px;
      line-height: 1.6;
      margin: 0;
      color: #000;
      padding: 20px;
      padding-top: var(--header-height-desktop);
      padding-bottom: calc(var(--footer-h) + 12px);
    }
    *,*::before,*::after { box-sizing: border-box; font: inherit; color: inherit; }
    #sticky-title { position: fixed; top: 0; left: 0; right: 0; z-index: 1000; display: none; padding: 10px 14px; background: transparent; }
    #sticky-title .title-box { margin: 0 auto; max-width: 700px; border-radius: 14px; background: rgb(0, 66, 37); color: rgb(255, 253, 208); padding: 14px 18px; text-align: center; box-shadow: 0 6px 18px rgba(0,0,0,.25); letter-spacing: .5px; }
    #game { max-width: 600px; margin: auto; text-align: center; }
    #number-section { margin: 18px 0 8px; }
    .bubble { display: inline-block; max-width: 100%; padding: 10px 14px; border-radius: 16px; background: #f2f7ff; border: 1px solid #cfe1ff; text-align: center; position: relative; }
    .bubble:after { content: ""; position: absolute; left: 24px; bottom: -10px; border-width: 10px 10px 0 10px; border-style: solid; border-color: #f2f7ff transparent transparent transparent; filter: drop-shadow(0 -1px 0 #cfe1ff); }
    .number-box { margin-top: 10px; display: flex; justify-content: center; gap: 10px; align-items: center; }
    #number-input { width: 200px; padding: 8px 10px; border: 1px solid #bbb; border-radius: 8px; text-align: center; font-size: 18px; line-height: 1.4; }
    .code-box { display: flex; justify-content: center; gap: 5px; margin: 10px 0; flex-wrap: wrap; }
    .code-box input { width: clamp(35px, 12vw, 45px); height: clamp(40px, 12vw, 50px); line-height: 1.2; text-align: center; text-transform: uppercase; padding: 0; }
    .code-box input:disabled { color: black; opacity: 1; -webkit-text-fill-color: black; }
    input[type="text"], textarea, select { margin-top: 10px; padding: 8px; width: 100%; border: 1px solid #bbb; border-radius: 6px; text-transform: capitalize; font-size: 18px; line-height: 1.4; }
    input::placeholder { opacity: .6; font-size: inherit; }
    button { margin-top: 10px; padding: 8px 15px; border-radius: 10px; border: none; background: #eee; cursor: pointer; }
    .hidden { display: none; }
    #pl-footer.hidden { display: none !important; }
    .hint { margin-top: 8px; font-style: italic; color: #444; }
    #intro-question, #main-q-text { text-align: justify; text-justify: inter-word; margin-bottom: 15px; }
    #intro-question br, #main-q-text br { display: block; margin-bottom: 75px; content: ""; }
    #pl-footer { position: fixed; left: 0; right: 0; bottom: 0; height: var(--footer-h); background: var(--pl-zero); transition: background-color 200ms ease; color: rgb(255, 253, 208); display: flex; align-items: center; justify-content: center; gap: 14px; padding: 0 16px; z-index: 1100; box-shadow: 0 -6px 18px rgba(0,0,0,.15); font-size: 18px; }
    #pl-footer.pl-positive { background: var(--pl-pos); }
    #pl-footer.pl-negative { background: var(--pl-neg); }
    #pl-footer .pill { padding: 6px 12px; border-radius: 999px; background: rgba(255,255,255,.1); border: 1px solid rgba(255,255,255,.2); }
    @media (max-width:600px) {
      body { padding: 32px 20px calc(var(--footer-h) + 16px) 20px; padding-top: var(--header-height-mobile); }
      #game { max-width: 100%; }
    }
  </style>
</head>

<body>
  <div id="sticky-title">
    <div class="title-box"><span id="title-question"></span></div>
  </div>

  <div id="game">
    <div id="intro">
      <h1>üîê Birthday Escape Room</h1>
      <h1>TO BE DELETED. VERSION: 01:39</h1>
      <h3>Can you solve all the puzzles and escape?</h3>
      <p>
        Rules:<br>
        1. Enter the correct postcodes to unlock each stage.<br>
        2. Choose your odds each round and verify.<br>
        3. Correct code: you win ‚Ç¨1. Wrong code: you lose your chosen odds (‚Ç¨X).<br>
        4. Use logic, creativity, and persistence!
      </p>
      <button onclick="startGame()">Start the Game</button>
    </div>

    <div id="question-stage" class="hidden">
      <h2 id="intro-question"></h2>

      <div id="number-section">
        <div id="number-instruction" class="bubble"></div>
        <div class="number-box">
          <input id="number-input" type="text" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" placeholder="Enter your odds" autocomplete="off" />
        </div>
        <div id="number-warning" class="hint" style="display:none;color:#b00;">Na mivan okosnak hiszed magad? ü§°).</div>
      </div>

      <div id="verification" class="hidden">
        <p>Enter the postcode:</p>
        <div class="code-box" id="code-inputs"></div>
        <button id="verify-btn" onclick="checkVerification()">Verify</button>
        <p id="verification-message"></p>
        <p id="hint" class="hint"></p>
      </div>

      <div id="main-question" style="display:none;">
        <h2 id="main-q-text"></h2>
        <input type="text" id="answer" placeholder="Your answer" autocapitalize="words">
        <button onclick="goBack()">Back</button>
        <button onclick="checkAnswer()">Submit</button>
        <p id="message"></p>
      </div>
    </div>
  </div>

  <div id="pl-footer" class="hidden">
    <span>Current P/L:</span>
    <span id="pl-value" class="pill">‚Ç¨0.00</span>
  </div>

  <script>
    const MASTER_CODE = "XXXXXX";
    const MASTER_ANSWER = "XXX";
    const NUM_NOTE = `üé≤ üé≤ Gambling time!! üé≤üé≤
    How confident are you that the answer you will give is correct?
    The house offers a bet size of ‚Ç¨1, choose your odds.`;
    const FINAL_TITLE = "The End";
    const ODDS_KEY = "oddsByQuestion";

    let oddsByQuestion = loadJSON(ODDS_KEY, {});
    let playerPL = 0;

    const questions = [
      {
        titleQ: "Spawn Point",
        introQ: `You wake up on a gorgeous sunny day in Amsterdam.
        After putting on your sunglasses as you ascend to the upper floor you feel a puissante hunger striking you. <p>
        To remedy that you shall choose a place to brunch. Where would you head?`,
        // answer: The Greek Embassy
        mainQ: "[Placeholder follow-up Q1]",
        a: "The Greek Embassy",
        code: "1091EJ"
      },
      {
        titleQ: "Checkpoint 1",
        introQ: `Pantha Rhei has done exceptionally well this year.
        It's AUM increased by 30.3% YoY and its returns were 51.7%, outperforming even legendary trader Nancy Pelosi. <p>
        All this didn't come cheap though, you deserve a peaceful leisure trip to Amsterdam.
        On your upcoming trip which hotel would you lodge at?`,
        // answer: Amstel Hotel
        mainQ: "[Placeholder follow-up Q2]",
        a: "Amstel Hotel",
        code: "1018GX"
      },
      {
        titleQ: "Checkpoint 2",
        introQ: `Utadat egyik kedves utc√°don folytatod, ahol a v√°ros l√ºktet≈ë vil√°ga √∂lel k√∂rbe.`,
        mainQ: `Miel≈ëtt az utca v√©get √©rne, egyszer csak megpillantasz valamit, amit≈ël felcsillan a szemed. Mit l√°tsz?`,
        // answer: Utrechtsestraat
        a: "Boerejongens",
        code: "1017XK",
        hint: "üí° A Te szemsz√∂gedb≈ël n√©zve az utca elej√©n lev≈ë jobb oldali √©p√ºlet ir√°ny√≠t√≥sz√°ma."
      },
      {
        titleQ: "Checkpoint 3",
        introQ: `Gratul√°lunk, √ñn k√∂zbeszerz√©st nyert! <p>
        P√°ly√°zat√°ban k√∂telezetts√©get v√°llalt a h√°ztart√°s t√∂bb √©vre sz√≥l√≥ √∂ngy√∫jt√≥-ell√°t√°s√°nak biztos√≠t√°s√°ra.
        Hol eszk√∂z√∂ln√© beszerz√©s√©t?`,
        // answer: Hartman Cigars
        mainQ: "[Placeholder follow-up Q4]",
        a: "Hartman Cigars",
        code: "1017PC"
      },
      {
        titleQ: "Checkpoint 4",
        introQ: `A boltt√≥l elindulv√°n egyszerre csak meghallod a term√©szet h√≠v√°s√°t. Honnan j√∂het?`,
        // answer: When Nature Calls
        mainQ: "Milyen m√°rka kaphat√≥ az √ºzlettel szembeni boltban?",
        a: "NIO",
        code: "1017EJ"
      },
      {
        titleQ: "Checkpoint 5",
        introQ: `After a wise decision of taking a rain check on those magic mushrooms you are still craving some miracle.
        Where does your journey continue?`,
        // answer: Heiligeweg
        mainQ: "[Placeholder follow-up Q6]",
        a: "NIO",
        code: "1012WP",
        hint: "üí° A Te szemsz√∂gedb≈ël n√©zve az utca elej√©n lev≈ë jobb oldali √©p√ºlet ir√°ny√≠t√≥sz√°ma."
      },
      {
        titleQ: "Checkpoint 6",
        introQ: `Next stop is your favorite book store`,
        // answer: Waterstones
        mainQ: "A bolthoz √©rv√©n mindkett≈ënknek felcsillan a szeme. Neked a bolt miatt, nekem viszont valami m√°s miatt. Mit l√°tok?",
        a: "Chatime",
        code: "1012XE"
      },
    ];

    let current = 0;
    let answers = Array(questions.length).fill("");

    function loadJSON(key, fallback) { try { const x = localStorage.getItem(key); return x ? JSON.parse(x) : fallback; } catch { return fallback; } }
    function saveJSON(key, val) { try { localStorage.setItem(key, JSON.stringify(val)); } catch { } }
    function parseOdds(str) { if (!str) return null; const num = parseFloat(str.replace(',', '.')); if (isNaN(num) || num <= 0) return null; return num; }
    function formatMoney(n) { const abs = Math.abs(n).toFixed(2); if (n > 0) return "+‚Ç¨" + abs; if (n < 0) return "‚àí‚Ç¨" + abs; return "‚Ç¨" + abs; }
    function refreshPL() {
      const el = document.getElementById("pl-value");
      const footer = document.getElementById("pl-footer");
      el.textContent = formatMoney(playerPL);
      footer.classList.remove("pl-positive","pl-negative");
      if (playerPL > 0) footer.classList.add("pl-positive");
      else if (playerPL < 0) footer.classList.add("pl-negative");
    }

    function startGame() {
      document.getElementById("intro").classList.add("hidden");
      document.getElementById("question-stage").classList.remove("hidden");
      document.getElementById("sticky-title").style.display = "block";
      document.getElementById("pl-footer").classList.remove("hidden");
      refreshPL();
      showQuestion();
    }

    function updateVerificationVisibility() {
      const raw = document.getElementById("number-input").value.trim();
      const odds = parseOdds(raw);
      const ver = document.getElementById("verification");
      if (odds !== null) ver.classList.remove("hidden");
      else ver.classList.add("hidden");
    }

    function showQuestion() {
      if (current < questions.length) {
        document.getElementById("title-question").textContent = questions[current].titleQ;
        document.getElementById("intro-question").innerHTML = questions[current].introQ;
        document.getElementById("main-q-text").innerHTML = "";
        document.getElementById("message").textContent = "";
        document.getElementById("verification-message").textContent = "";
        document.getElementById("hint").textContent = questions[current].hint || "";

        document.getElementById("number-instruction").innerHTML = NUM_NOTE.replaceAll("\n", "<br>");
        document.getElementById("number-section").style.display = "block";
        document.getElementById("number-warning").style.display = "none";
        const numInput = document.getElementById("number-input");
        numInput.value = (oddsByQuestion[current] ?? "").toString();
        numInput.oninput = updateVerificationVisibility;

        const code = questions[current].code;
        const container = document.getElementById("code-inputs");
        container.innerHTML = "";
        for (let i = 0; i < 6; i++) {
          const input = document.createElement("input");
          input.maxLength = 1;
          if (i <= 3) input.setAttribute("inputmode", "numeric"); else input.setAttribute("inputmode", "text");
          if (i === 0 || i === 1 || i === 4) { input.value = code[i]; input.disabled = true; }
          input.addEventListener("input", function () {
            if (this.value.length === 1) {
              let next = this.nextElementSibling; while (next && next.disabled) next = next.nextElementSibling;
              if (next) next.focus();
            }
          });
          input.addEventListener("keydown", function (e) {
            if (e.key === "Backspace" && this.value === "") {
              let prev = this.previousElementSibling; while (prev && prev.disabled) prev = prev.previousElementSibling;
              if (prev) prev.focus();
            }
          });
          container.appendChild(input);
        }

        const ver = document.getElementById("verification");
        ver.style.display = "";
        ver.classList.add("hidden");
        document.getElementById("main-question").style.display = "none";
        document.getElementById("answer").value = answers[current] || "";
        updateVerificationVisibility();
      } else {
        document.getElementById("title-question").textContent = FINAL_TITLE;
        document.getElementById("question-stage").innerHTML = `<h2>üéâ You Escaped!</h2><p>Final P/L shown below.</p>`;
      }
    }

    function checkVerification() {
      const raw = document.getElementById("number-input").value.trim();
      const odds = parseOdds(raw);
      if (raw !== "" && odds === null) {
        document.getElementById("number-warning").style.display = "block";
        return;
      }
      document.getElementById("number-warning").style.display = "none";
      if (odds !== null) { oddsByQuestion[current] = odds; saveJSON(ODDS_KEY, oddsByQuestion); }

      const code = questions[current].code;
      const inputs = document.querySelectorAll("#code-inputs input");
      let entered = "", expected = "", masterSlice = "";
      inputs.forEach((inp, i) => {
        if (!inp.disabled) {
          entered += inp.value.toUpperCase();
          expected += code[i].toUpperCase();
          masterSlice += MASTER_CODE[i];
        }
      });

      if (entered === expected || entered === masterSlice) {
        playerPL += 1;
        refreshPL();
        document.getElementById("verification").classList.add("hidden");
        document.getElementById("number-section").style.display = "none";
        document.getElementById("main-question").style.display = "block";
        document.getElementById("main-q-text").innerHTML = questions[current].mainQ;
        document.getElementById("answer").value = answers[current] || "";
        document.getElementById("answer").focus();
      } else {
        const loss = odds ?? 0;
        playerPL -= loss;
        refreshPL();
        document.getElementById("verification-message").textContent =
          loss > 0 ? `‚ùå Wrong code. You lose ‚Ç¨${loss.toFixed(2)} this round.` : "‚ùå Wrong code. Enter odds to risk an amount.";
      }
    }

    function checkAnswer() {
      const input = document.getElementById("answer").value.trim();
      answers[current] = input;
      const correct = questions[current].a.toLowerCase();
      if (input.toLowerCase() === correct || input.toLowerCase() === MASTER_ANSWER.toLowerCase()) {
        current++;
        showQuestion();
      } else {
        document.getElementById("message").textContent = "‚ùå Wrong answer, try again!";
      }
    }

    function goBack() { if (current > 0) current--; else current = 0; showQuestion(); }

    document.addEventListener("keyup", function (e) {
      if (e.key === "Enter") {
        const ver = document.getElementById("verification");
        const verifyVisible = !ver.classList.contains("hidden");
        const mainVisible = document.getElementById("main-question").style.display !== "none";
        if (verifyVisible) checkVerification();
        else if (mainVisible) checkAnswer();
      }
    });
  </script>
</body>

</html>
