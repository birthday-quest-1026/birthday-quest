<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=yes, minimum-scale=0.2, maximum-scale=6">
  <title>Escape Room</title>
  <link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=UnifrakturCook:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root {
      --header-height-desktop: 88px;
      --header-height-mobile: 96px;
      --footer-h: 58px;
      --pl-pos: rgb(0, 66, 37);
      --pl-zero: rgb(74, 65, 42);
      --pl-neg: rgb(109, 3, 2)
    }

    .ancient {
      font-family: 'MedievalSharp', cursive;
      font-size: 1em;
      letter-spacing: 0.05em;
    }

    html {
      -webkit-text-size-adjust: 100%
    }

    html,
    body {
      touch-action: pan-x pan-y pinch-zoom;
    }

    body {
      font-family: 'Special Elite', monospace;
      font-size: 18px;
      line-height: 1.6;
      margin: 0;
      color: #000;
      padding: 20px;
      padding-top: var(--header-height-desktop);
      padding-bottom: calc(var(--footer-h) + 12px)
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
      font: inherit;
      color: inherit
    }

    #sticky-title {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      display: none;
      padding: 10px 14px;
      background: transparent
    }

    #sticky-title .title-box {
      margin: 0 auto;
      max-width: 700px;
      border-radius: 14px;
      background: rgb(0, 66, 37);
      color: rgb(255, 253, 208);
      padding: 14px 18px;
      text-align: center;
      box-shadow: 0 6px 18px rgba(0, 0, 0, .25);
      letter-spacing: .5px
    }

    #game {
      max-width: 600px;
      margin: auto;
      text-align: center
    }

    #number-section {
      margin: 18px 0 8px
    }

    .bubble {
      display: inline-block;
      max-width: 100%;
      padding: 16px 20px;
      border-radius: 16px;
      background: #f2f7ff;
      border: 1px solid #cfe1ff;
      text-align: center;
      position: relative
    }

    .bubble:after {
      content: "";
      position: absolute;
      left: 24px;
      bottom: -10px;
      border-width: 10px 10px 0 10px;
      border-style: solid;
      border-color: #f2f7ff transparent transparent transparent
    }

    #num-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 8px
    }

    #number-instruction .info-btn {
      display: inline-block;
      margin-top: 8px;
      padding: 6px 14px;
      border-radius: 999px;
      background: #eef0ff;
      border: 1px solid #c9d0ff;
      font-size: 14px;
      cursor: pointer
    }

    #number-instruction .info-btn:focus {
      outline: none
    }

    #number-instruction .info-btn:focus-visible {
      outline: 2px solid #c9d0ff
    }

    #number-instruction .info-pop {
      margin: 14px auto 0;
      padding: 14px 18px;
      border-radius: 12px;
      background: #fff;
      border: 1px solid #cfe1ff;
      font-size: 16px;
      line-height: 1.55;
      text-align: center;
      display: inline-block;
      width: min(520px, 90%);
      box-shadow: 0 3px 8px rgba(0, 0, 0, .08)
    }

    #number-instruction .info-pop.hidden {
      display: none !important
    }

    .number-box {
      margin-top: 10px;
      display: flex;
      justify-content: center;
      gap: 10px;
      align-items: center
    }

    #number-input {
      width: 200px;
      padding: 8px 10px;
      border: 1px solid #bbb;
      border-radius: 8px;
      text-align: center;
      font-size: 18px;
      line-height: 1.4
    }

    .code-box {
      display: flex;
      justify-content: center;
      gap: 5px;
      margin: 10px 0;
      flex-wrap: wrap
    }

    .code-box input {
      width: clamp(35px, 12vw, 45px);
      height: clamp(40px, 12vw, 50px);
      line-height: 1.2;
      text-align: center;
      text-transform: uppercase;
      padding: 0
    }

    .code-box input:disabled {
      color: black;
      opacity: 1;
      -webkit-text-fill-color: black
    }

    input[type="text"],
    textarea,
    select {
      margin-top: 10px;
      padding: 8px;
      width: 100%;
      border: 1px solid #bbb;
      border-radius: 6px;
      text-transform: capitalize;
      font-size: 18px;
      line-height: 1.4
    }

    input::placeholder {
      opacity: .6;
      font-size: inherit
    }

    button {
      margin-top: 10px;
      padding: 8px 15px;
      border-radius: 10px;
      border: none;
      background: #eee;
      cursor: pointer
    }

    .hidden {
      display: none !important
    }

    #pl-footer.hidden {
      display: none !important
    }

    .hint {
      margin-top: 8px;
      font-style: italic;
      color: #444
    }

    #intro-question,
    #main-q-text {
      text-align: justify;
      text-justify: inter-word;
      margin-bottom: 15px
    }

    #intro-question br,
    #main-q-text br {
      display: block;
      margin-bottom: 75px;
      content: ""
    }

    #pl-footer {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: var(--footer-h);
      background: var(--pl-zero);
      transition: background-color 200ms ease;
      color: rgb(255, 253, 208);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 14px;
      padding: 0 16px;
      z-index: 1100;
      box-shadow: 0 -6px 18px rgba(0, 0, 0, .15);
      font-size: 18px
    }

    #pl-footer.pl-positive {
      background: var(--pl-pos)
    }

    #pl-footer.pl-negative {
      background: var(--pl-neg)
    }

    #pl-footer .pill {
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(255, 255, 255, .1);
      border: 1px solid rgba(255, 255, 255, .2)
    }

    #map {
      width: 100%;
      height: 340px;
      border-radius: 14px;
      overflow: hidden;
      margin: 10px 0 4px
    }

    #map-status {
      font-size: 14px;
      color: #555;
      margin-bottom: 8px
    }

    #intro {
      padding-bottom: 350px
    }

    #intro-instruction .info-btn {
      display: inline-block;
      margin-top: 8px;
      padding: 6px 14px;
      border-radius: 999px;
      background: #eef0ff;
      border: 1px solid #c9d0ff;
      font-size: 14px;
      cursor: pointer
    }

    #intro-instruction .info-btn:focus {
      outline: none
    }

    #intro-instruction .info-btn:focus-visible {
      outline: 2px solid #c9d0ff
    }

    #intro-instruction .info-pop {
      margin: 14px auto 0;
      padding: 14px 18px;
      border-radius: 12px;
      background: #fff;
      border: 1px solid #cfe1ff;
      font-size: 16px;
      line-height: 1.55;
      text-align: center;
      display: inline-block;
      width: min(520px, 90%);
      box-shadow: 0 3px 8px rgba(0, 0, 0, .08)
    }

    #intro-instruction .info-pop.hidden {
      display: none !important
    }

    #skyline {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: 300px;
      pointer-events: none;
      background-image: url('silhouette2.png');
      background-repeat: repeat-x;
      background-position: center calc(100% + 70px);
      background-size: auto 100%;
      opacity: .9;
      z-index: 0;
    }

    @media (max-width:600px) {
      body {
        padding: 32px 20px calc(var(--footer-h) + 16px) 20px;
        padding-top: var(--header-height-mobile);
        font-size: 16px;
      }

      #game {
        max-width: 100%;
      }

      #sticky-title .title-box {
        font-size: 18px;
        padding: 10px 14px;
      }

      #num-title {
        font-size: 18px;
      }

      button,
      input[type="text"],
      textarea,
      select {
        font-size: 16px;
      }

      #number-input {
        width: 170px;
      }

      .code-box input {
        width: clamp(32px, 11vw, 40px);
        height: clamp(36px, 11vw, 46px);
      }

      #map {
        height: 260px;
      }

      #skyline {
        background-position: center calc(100% + 120px);
      }
    }

    #intro-instruction {
      display: block;
      margin: 0 auto 16px;
    }

    #intro>button[onclick="startGame()"] {
      display: block;
      margin: 0 auto;
    }

    #end-screen {
      padding-bottom: 350px;
    }

    @media (max-width: 600px) {
      #skyline {
        height: 420px;
      }

      #intro,
      #end-screen {
        padding-bottom: 500px;
      }
    }

    #pdf-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1200;
      padding: 12px;
      overscroll-behavior: contain;
    }

    #pdf-dialog {
      background: #fff;
      width: min(900px, 95vw);
      height: min(92vh, 900px);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .3);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #pdf-dialog-header {
      display: flex;
      gap: 10px;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid #eee;
      font-weight: 700;
      flex-wrap: wrap;
    }

    #pdf-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #pdf-close {
      appearance: none;
      border: 1px solid #ddd;
      background: #f6f6f6;
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
    }

    .zoom-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: normal;
    }

    .zoom-controls input[type="number"] {
      width: 68px;
      text-align: right;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }

    .zoom-controls button {
      margin: 0;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: #f6f6f6;
      cursor: pointer;
    }

    .zoom-slider {
      width: 140px;
    }

    #pdf-viewport {
      flex: 1;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      touch-action: pan-x pan-y pinch-zoom;
      background: #fff;
    }

    #pdf-iframe {
      border: 0;
      transform-origin: top left;
      display: block;
    }

    #pdf-hint.hidden {
      display: none !important;
    }

    #go-start {
      display: block;
      margin: 24px auto 40px auto;
      padding: 10px 16px;
      border-radius: 10px;
      border: 1px solid #ddd;
      background: #f6f6f6;
      cursor: pointer;
      max-width: 600px;
      width: 90%;
    }
  </style>
</head>

<body>
  <div id="sticky-title">
    <div class="title-box"><span id="title-question"></span></div>
  </div>

  <div id="game">
    <div id="intro">
      <h1 style="font-size: 32px;">Boldog születésnapot!</h1>
      <h3 style="font-size: 20px;">🕵️‍♂️🕵️‍♂️ Birthday Quest 🕵️‍♂️🕵️‍♂️</h3>

      <div id="intro-instruction" class="bubble">
        <div id="intro-num-title">Instructions</div>
        <button id="intro-info-btn" class="info-btn" type="button" aria-expanded="false">+ Kiváncsi vagyok a
          részletekre! +</button>
        <div id="intro-info-pop" class="info-pop hidden"></div>
      </div>

      <button onclick="startGame()">Start the Game</button>
    </div>

    <div id="question-stage" class="hidden">
      <h2 id="intro-question"></h2>

      <div id="pdf-hint" class="bubble hidden" style="margin:0 auto 10px; cursor:pointer;" role="button" tabindex="0"
        aria-label="Megnyitás: Értesítő (PDF)">
        📄📄 <strong>Közbeszerzési Értesítő</strong> 📄📄<br> Kattintson a megtekintéshez!
      </div>

      <div id="number-section">
        <div id="number-instruction" class="bubble">
          <div id="num-title">🎲🎲 Gambling time! 🎲🎲</div>
          <button id="info-btn" class="info-btn" type="button" aria-expanded="false">More info</button>
          <div id="info-pop" class="info-pop hidden"></div>
        </div>

        <div class="number-box">
          <input id="number-input" type="text" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
            placeholder="Enter your odds" autocomplete="off" />
        </div>
        <div id="number-warning" class="hint" style="display:none;color:#b00;">Na mivan okosnak hiszed magad? 🤡).</div>
      </div>

      <div id="verification" class="hidden">
        <p>Enter the postcode:</p>
        <div class="code-box" id="code-inputs"></div>
        <button id="verify-btn" onclick="checkVerification()">Verify</button>
        <p id="verification-message"></p>
        <p id="hint" class="hint"></p>
      </div>

      <div id="map" class="hidden"></div>
      <div id="map-status" class="hidden"></div>

      <div id="main-question" style="display:none;">
        <h2 id="main-q-text"></h2>
        <input type="text" id="answer" placeholder="Your answer" autocapitalize="words">
        <button onclick="checkAnswer()">Submit</button>
        <p id="message"></p>
      </div>
    </div>

    <div id="bonus-screen" class="hidden">
      <h2>🎁🎁 Bonus Question 🎁🎁</h2>
      <p>Please enter the exact color code of the green color used:</p>
      <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
        <label>R
          <input id="rgb-r" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="2"
            style="width:90px;text-align:center">
        </label>
        <label>G
          <input id="rgb-g" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="2"
            style="width:90px;text-align:center">
        </label>
        <label>B
          <input id="rgb-b" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="2"
            style="width:90px;text-align:center">
        </label>
      </div>
      <button id="bonus-verify" type="button" onclick="verifyBonus()">Submit</button>
      <p id="bonus-msg" class="hint"></p>
    </div>

    <div id="end-screen" class="hidden">
      <h1 style="margin-bottom:12px;">🎉 Yeeey 🎉</h1>
      <p>Szép munka!</p>
      <p id="end-score"></p>
      <p id="end-firsttry"></p>
      <p id="end-pl"></p>
      <p id="end-bets-total"></p>
      <p id="end-bets" class="hint"></p>
      <canvas id="bet-chart" width="560" height="240" style="max-width:100%;"></canvas>
    </div>
  </div>

  <div id="skyline" aria-hidden="true"></div>

  <div id="pdf-modal" role="dialog" aria-modal="true" aria-labelledby="pdf-title">
    <div id="pdf-dialog">
      <div id="pdf-dialog-header">
        <div id="pdf-left">
          <div id="pdf-title">Értesítő (PDF)</div>
        </div>

        <div class="zoom-controls" aria-label="Zoom controls">
          <button id="zoom-out" type="button">−</button>
          <input id="zoom-range" class="zoom-slider" type="range" min="30" max="300" value="100" step="5"
            aria-label="Zoom slider">
          <button id="zoom-in" type="button">+</button>
          <input id="zoom-input" type="number" min="30" max="300" step="5" value="100" aria-label="Zoom percent">%
        </div>

        <button id="pdf-close" type="button">Close</button>
      </div>

      <div id="pdf-viewport">
        <iframe id="pdf-iframe" src=""></iframe>
      </div>
    </div>
  </div>

  <div id="pl-footer" class="hidden">
    <span>Current P/L:</span>
    <span id="pl-value" class="pill">€0.00</span>
  </div>

  <button id="go-start" type="button">Retreat to Home Page</button>

  <script>
    const MASTER_CODES = ["XXXXXX", "0000XX"]
    const MASTER_ANSWER = "XXX"
    const NUM_TITLE = "🎲🎲 Gambling time! 🎲🎲"
    const INFO_TEXT = `How confident are you that the answer you will give is correct?<br>The house offers a bet size of €1, choose your odds.<br>Enter odds, then type the postcode to verify.<br>Correct code: +€1. Wrong code: you lose your chosen odds.`
    const FINAL_TITLE = "The End"
    const BASE_START = [47.497563, 19.053812];
    let lastReachedIndex = -1;

    const BONUS_RGB = [0, 66, 37];

    let oddsByQuestion = {}
    let playerPL = 0
    let betLog = []

    const INTRO_INFO_HTML = `1. Enter the correct postcodes to unlock each stage.<br>
    2. Answer the subsequent questions to progress to the next stage.<br>
    3. Legyél okos.`

    const questions = [
      { titleQ: "Spawn Point", introQ: `You wake up on a gorgeous sunny day in Amsterdam. After putting on your sunglasses as you ascend to the upper floor you feel a puissante hunger striking you. <p> To remedy that you shall choose a place to brunch. Where would you head to?`, mainQ: "Mi a menün található 4. ételnek a neve?", a: "Spetsofai Pie", code: "1091EJ", coords: [52.352937, 4.910438] },
      { titleQ: "Checkpoint 1", introQ: `<span class="ancient">Pantha Rhei</span>&#8482 has done exceptionally well this year. It's AUM increased by 30.3% YoY and its returns were 51.7%, outperforming even legendary trader Nancy Pelosi. <p> All this didn't come cheap though, you deserve a peaceful leisure trip to Amsterdam. On your upcoming trip which hotel would you lodge at?`, mainQ: "ANSWER NOT UPDATED TO BE EDITED - Kinek a szobra található a hotel bejárata előtt?", a: "Amstel Hotel", code: "1018GX", coords: [52.360062, 4.904937] },
      { titleQ: "Checkpoint 2", introQ: `Utadat egyik kedves utcádon folytatod, ahol a város lüktető világa ölel körbe.`, mainQ: `Kezdj el sétálni az utcán. Mielőtt az véget érne, megpillantasz valamit, amitől hirtelen felcsillan a szemed. Mit látsz? Milyen állat néz veled farkasszemet?`, a: "Bagoly", code: "1017XK", hint: "💡 A Te szemszögedből nézve az utca elején levő jobb oldali épület irányítószáma.", coords: [52.361062, 4.899437] },
      { titleQ: "Checkpoint 3", introQ: `Újdonsült titkosmikkentyűd azt kéri tőled, hogy menj a második legközelebbi térre, hogy elfogyaszd. (A legközelebbi nyilvánvalóan kiesik).`, mainQ: `Ezen a ponton valószínűleg Arnoldnak már pisilnie kell, miután elvégzi dolgát megtetszik a csatorna látványa. Ideális esetben ezelőtt a gyönyörű ház előtt fogtok leülni Bismarck társaságában megvitatni az élet kérdéseit. Mi a házszám?`, a: "59", code: "1017JD", coords: [52.362188, 4.898312] },
      { titleQ: "Checkpoint 4", introQ: `Keresd meg a Vijzelstraat és Reguliersgracht között található (nagy valószínűséggel őrült) porcelános néni üzletét`, mainQ: `Hogy hívják az üzletet?`, a: "Golden Bend", code: "1017CC", coords: [52.364812, 4.893937] },
      { titleQ: "Checkpoint 5", introQ: `Következő checkpointod (tulajdonképp) a VOC egyik (volt) irodaépülete.`, mainQ: `Kezdj el felfele haladni a lépcsőházban. Ki van Mercurius és Jupiter között?`, a: "F.S. Van Nierop", code: "1017CB", coords: [52.364438, 4.892188] },
      { titleQ: "Checkpoint 6", introQ: `Gratulálunk, Ön közbeszerzést nyert! <p> Hol eszközölné beszerzését a pályázatban foglaltak teljesítésére?`, mainQ: "Hány eurót hagytál a boltban?", a: "5", code: "1017PC", coords: [52.365562, 4.885438] },
      { titleQ: "Checkpoint 7", introQ: `A bolttól elindulván egyszerre csak meghallod a természet hívását. Honnan jöhet?`, mainQ: "Milyen márka kapható az üzlettel szembeni boltban?", a: "NIO", code: "1017EJ", coords: [52.365813, 4.886062] },
      { titleQ: "Checkpoint 8", introQ: `After a wise decision of taking a rain check on those magic mushrooms you are still craving some miracle. Where would an Amsterdammer from a bygone era go to view some miracle? Where does your journey continue?`, mainQ: `You want to test your brand new lighter. But not anyhow. In style. Like a movie star. Which coffeeshop in the close vicinity is featured in a movie?`, a: "Dampkring", code: "1012WP", hint: "💡 A Te szemszögedből nézve az utca elején levő jobb oldali épület irányítószáma.", coords: [52.367438, 4.890187] },
      { titleQ: "Checkpoint 9", introQ: `Before you would put your new lighter to the test and fulfill your sensual/spiritual desire, you first want to fulfill some intellectual desires. Next stop is your favorite book store.`, mainQ: `A bolthoz érvén mindkettőnknek felcsillan a szeme. Neked a könyvesbolt miatt, nekem viszont valami más miatt. Mit látok?`, a: "Chatime", code: "1012XE", coords: [52.368813, 4.891063] },
      { titleQ: "Checkpoint 10", introQ: `Your next stop is the brand new UvA library`, mainQ: `Complete the phrase: But do read, __ ______ ___ ____ __ ____.`, a: "it doesn't say what it says", code: "1012CP", hint: "💡 Please enter the postcode of the nicest hospitality establishment in the immediate vicinity.", coords: [52.368063, 4.895437] },
      { titleQ: "Checkpoint 11", introQ: `Következő megálló Amszterdam legjobb coffeeshopja.`, mainQ: `ANSWER NOT UPDATED TO BE EDITED - Válaszd ki a menün az X-ik sativa prerolled-ot. Mi a neve?`, a: "", code: "1012PL", coords: [52.372062, 4.891188] },
      { titleQ: "Checkpoint 12", introQ: `Kezdesz megéhezni? Látogass el egy helyre, ahol közel-keleti ízvilágú remekműveket tudsz enni.`, mainQ: `<div style="text-align:center;font-family:'UnifrakturCook',serif;font-style:italic;font-size:22px;margin-bottom:18px;">Homo Sapiens Non Urinat In Ventum </div> Hány oszlop kell e bölcsesség támasztására?`, a: "7", code: "1016AS", coords: [52.368688, 4.887313] },
      { titleQ: "Checkpoint 13", introQ: `Next stop is Vondelpark. Being a proactive fella, you decide to equip yourself with some water. Where do you go?`, mainQ: `What is the (official) name of the location in the park where you would go?`, a: "Rosarium Vondelpark", code: "1054ES", coords: [52.361812, 4.881063] }
    ]

    let current = 0
    let answers = Array(questions.length).fill("")
    let attemptsByQuestion = Array(questions.length).fill(0)
    let firstTryCorrect = Array(questions.length).fill(null)

    function parseOdds(str) { if (!str) return null; const n = parseFloat(str.replace(',', '.')); if (isNaN(n) || n <= 0) return null; return n }
    function formatMoney(n) { const abs = Math.abs(n).toFixed(2); if (n > 0) return "+€" + abs; if (n < 0) return "−€" + abs; return "€" + abs }
    function refreshPL() { const el = document.getElementById("pl-value"); const f = document.getElementById("pl-footer"); el.textContent = formatMoney(playerPL); f.classList.remove("pl-positive", "pl-negative"); if (playerPL > 0) f.classList.add("pl-positive"); else if (playerPL < 0) f.classList.add("pl-negative") }

    let map, tiles, pathLayer, marker, targetMarker

    function ensureMap() {
      const mapEl = document.getElementById('map');
      const stat = document.getElementById('map-status');
      mapEl.classList.remove('hidden');
      stat.classList.remove('hidden');
      if (map) { setMapToCurrent(); return }

      map = L.map('map', { zoomControl: true });
      tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: "© OpenStreetMap" });
      tiles.addTo(map);

      pathLayer = L.polyline([], { color: 'black', weight: 3, dashArray: '6, 6' }).addTo(map);

      const start = BASE_START;

      const vanmoofIcon = L.icon({
        iconUrl: 'vanmoof.png',
        iconSize: [100, 60],
        iconAnchor: [20, 20]
      });

      marker = L.marker(start, { icon: vanmoofIcon }).addTo(map);
      targetMarker = L.circleMarker(start, { radius: 6, weight: 0, fillColor: 'black', fillOpacity: .9 }).addTo(map);
      map.setView(start, 13);
    }

    function setMapToCurrent() {
      const c = lastReachedIndex < 0 ? BASE_START : (questions[lastReachedIndex].coords || marker.getLatLng());
      marker.setLatLng(c);
      targetMarker.setLatLng(c);
      pathLayer.setLatLngs([c]);
      map.setView(c, 14);
    }

    function lerp(a, b, t) { return a + (b - a) * t }
    function lerpLatLng(a, b, t) { return [lerp(a[0], b[0], t), lerp(a[1], b[1], t)] }

    function animateLeg(from, to, durationMs) {
      const startTime = performance.now()
      pathLayer.setLatLngs([from, to])
      targetMarker.setLatLng(to)
      map.fitBounds(L.latLngBounds([from, to]).pad(0.25))
      return new Promise(resolve => { function f(now) { const t = Math.min(1, (now - startTime) / durationMs); const e = t < .5 ? 2 * t * t : -1 + (4 - 2 * t) * t; const p = lerpLatLng(from, to, e); marker.setLatLng(p); if (t < 1) requestAnimationFrame(f); else resolve() } requestAnimationFrame(f) })
    }

    const STORAGE_KEY = 'escape_room_state_v1';
    function saveState() {
      try {
        const state = { current, answers, oddsByQuestion, playerPL, betLog, lastReachedIndex, started: true, attemptsByQuestion, firstTryCorrect };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) { }
    }
    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : null;
      } catch (e) { return null; }
    }
    function resetState() {
      try { localStorage.removeItem(STORAGE_KEY); } catch (e) { }
    }

    function startGame(resume = false) {
      document.getElementById("skyline").style.display = "none";
      document.getElementById("intro").classList.add("hidden")
      document.getElementById("question-stage").classList.remove("hidden")
      document.getElementById("bonus-screen").classList.add("hidden")
      document.getElementById("end-screen").classList.add("hidden")
      document.getElementById("sticky-title").style.display = "block"
      document.getElementById("pl-footer").classList.remove("hidden")

      if (resume) {
        const s = loadState();
        if (s && s.started) {
          current = Math.min(s.current ?? 0, questions.length - 1);
          answers = Array.isArray(s.answers) ? s.answers : answers;
          oddsByQuestion = s.oddsByQuestion ?? {};
          playerPL = Number.isFinite(s.playerPL) ? s.playerPL : 0;
          betLog = Array.isArray(s.betLog) ? s.betLog : [];
          lastReachedIndex = Number.isInteger(s.lastReachedIndex) ? s.lastReachedIndex : -1;
          attemptsByQuestion = Array.isArray(s.attemptsByQuestion) ? s.attemptsByQuestion : Array(questions.length).fill(0);
          firstTryCorrect = Array.isArray(s.firstTryCorrect) ? s.firstTryCorrect : Array(questions.length).fill(null);
        } else {
          resetState();
        }
      } else {
        resetState();
        current = 0;
        answers = Array(questions.length).fill("");
        oddsByQuestion = {};
        playerPL = 0;
        betLog = [];
        lastReachedIndex = -1;
        attemptsByQuestion = Array(questions.length).fill(0);
        firstTryCorrect = Array(questions.length).fill(null);
      }

      ensureMap()
      refreshPL()
      showQuestion()
      saveState()
    }

    function goToStart() {
      resetState();
      current = 0;
      answers = Array(questions.length).fill("");
      oddsByQuestion = {};
      playerPL = 0;
      betLog = [];
      lastReachedIndex = -1;
      attemptsByQuestion = Array(questions.length).fill(0);
      firstTryCorrect = Array(questions.length).fill(null);

      document.getElementById("question-stage").classList.add("hidden")
      document.getElementById("bonus-screen").classList.add("hidden")
      document.getElementById("end-screen").classList.add("hidden")
      document.getElementById("intro").classList.remove("hidden")
      document.getElementById("sticky-title").style.display = "none"
      document.getElementById("pl-footer").classList.add("hidden")
      document.getElementById("skyline").style.display = "block"
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function updateVerificationVisibility() {
      const raw = document.getElementById("number-input").value.trim()
      const odds = parseOdds(raw)
      const ver = document.getElementById("verification")
      if (odds !== null) ver.classList.remove("hidden"); else ver.classList.add("hidden")
      document.getElementById("verification-message").textContent = ""
    }

    function toggleInfo() {
      const pop = document.getElementById("info-pop")
      const btn = document.getElementById("info-btn")
      const opening = pop.classList.contains("hidden")
      if (opening) { pop.innerHTML = INFO_TEXT; pop.classList.remove("hidden"); btn.textContent = "- Tűnj el a gecibe! -"; btn.setAttribute("aria-expanded", "true") }
      else { pop.classList.add("hidden"); btn.textContent = "+ Kiváncsi vagyok a részletekre! +"; btn.setAttribute("aria-expanded", "false") }
    }

    function toggleIntroInfo() {
      const pop = document.getElementById("intro-info-pop")
      const btn = document.getElementById("intro-info-btn")
      const opening = pop.classList.contains("hidden")
      if (opening) { pop.innerHTML = INTRO_INFO_HTML; pop.classList.remove("hidden"); btn.textContent = "- Tűnj el a gecibe! -"; btn.setAttribute("aria-expanded", "true") }
      else { pop.classList.add("hidden"); btn.textContent = "+ Kiváncsi vagyok a részletekre! +"; btn.setAttribute("aria-expanded", "false") }
    }

    function showQuestion() {
      document.getElementById("title-question").textContent = questions[current].titleQ || ""
      document.getElementById("intro-question").innerHTML = questions[current].introQ || ""
      document.getElementById("num-title").textContent = NUM_TITLE
      document.getElementById("info-pop").classList.add("hidden")
      const btn = document.getElementById("info-btn")
      btn.textContent = "+ Kiváncsi vagyok a részletekre! +"
      btn.setAttribute("aria-expanded", "false")
      btn.onclick = toggleInfo
      document.getElementById("number-section").style.display = "block"
      document.getElementById("number-warning").style.display = "none"
      const numInput = document.getElementById("number-input")
      numInput.value = (oddsByQuestion[current] ?? "").toString()
      numInput.oninput = updateVerificationVisibility
      const code = questions[current].code || "0000AA"
      const container = document.getElementById("code-inputs")
      container.innerHTML = ""
      for (let i = 0; i < 6; i++) {
        const input = document.createElement("input")
        input.maxLength = 1
        if (i <= 3) input.setAttribute("inputmode", "numeric"); else input.setAttribute("inputmode", "text")
        if (i === 0 || i === 1 || i === 4) { input.value = code[i]; input.disabled = true }
        input.addEventListener("input", function () { if (this.value.length === 1) { let next = this.nextElementSibling; while (next && next.disabled) next = next.nextElementSibling; if (next) next.focus() } })
        input.addEventListener("keydown", function (e) { if (e.key === "Backspace" && this.value === "") { let prev = this.previousElementSibling; while (prev && prev.disabled) prev = prev.previousElementSibling; if (prev) prev.focus() } })
        input.addEventListener("input", function () { document.getElementById("verification-message").textContent = "" })
        container.appendChild(input)
      }
      const ver = document.getElementById("verification")
      ver.style.display = ""
      ver.classList.add("hidden")
      document.getElementById("main-question").style.display = "none"
      document.getElementById("answer").value = answers[current] || ""
      document.getElementById("message").textContent = ""
      document.getElementById("answer").oninput = function () { document.getElementById("message").textContent = "" }
      document.getElementById("verification-message").textContent = ""
      const hintEl = document.getElementById("hint");
      const qHint = questions[current].hint;
      if (qHint && qHint.trim() !== "") {
        hintEl.innerHTML = qHint;
        hintEl.style.display = "block";
      } else {
        hintEl.textContent = "";
        hintEl.style.display = "none";
      }
      document.getElementById("verification").insertBefore(hintEl, document.getElementById("code-inputs"));

      ensureMap();
      setMapToCurrent();
      updateVerificationVisibility();
      window.scrollTo({ top: 0, behavior: "smooth" });

      const pdfHint = document.getElementById("pdf-hint");
      if ((questions[current].code || "") === "1017PC") {
        pdfHint.classList.remove("hidden");
      } else {
        pdfHint.classList.add("hidden");
      }

      saveState();
    }

    function checkVerification() {
      const raw = document.getElementById("number-input").value.trim()
      const odds = parseOdds(raw)
      if (raw !== "" && odds === null) { document.getElementById("number-warning").style.display = "block"; return }
      document.getElementById("number-warning").style.display = "none"
      if (odds !== null) { oddsByQuestion[current] = odds; saveState(); }
      const code = questions[current].code || ""
      const inputs = document.querySelectorAll("#code-inputs input")
      let entered = "", expected = ""
      let allFilled = true
      const masterSlices = Array(MASTER_CODES.length).fill("")
      inputs.forEach((inp, i) => { if (!inp.disabled) { if (inp.value === "") allFilled = false; entered += inp.value.toUpperCase(); expected += (code[i] || "").toUpperCase(); for (let k = 0; k < MASTER_CODES.length; k++) { masterSlices[k] += (MASTER_CODES[k][i] || "") } } })
      if (!allFilled) { document.getElementById("verification-message").textContent = ""; return }
      if (entered === expected || masterSlices.includes(entered)) {
        const usedOdds = oddsByQuestion[current] ?? odds ?? 0
        playerPL += 1; refreshPL(); betLog.push({ q: current + 1, odds: usedOdds, outcome: 1 }); saveState();
        const stat = document.getElementById('map-status');
        const to = questions[current].coords;
        const from = lastReachedIndex < 0 ? BASE_START : questions[lastReachedIndex].coords;

        if (to) {
          stat.textContent = `Utazás: ${lastReachedIndex < 0 ? 'Base' : questions[lastReachedIndex].titleQ} → ${questions[current].titleQ}`;
          animateLeg(from, to, 3500).then(() => {
            lastReachedIndex = current;
            stat.textContent = `Rough Rider is at ${questions[current].titleQ}`;
            saveState();
          });
        }
        document.getElementById("verification").classList.add("hidden")
        document.getElementById("number-section").style.display = "none"
        document.getElementById("main-question").style.display = "block"
        document.getElementById("main-q-text").innerHTML = questions[current].mainQ || ""
        document.getElementById("answer").value = answers[current] || ""
        document.getElementById("answer").focus()
        document.getElementById("message").textContent = ""
      } else {
        const loss = odds ?? 0; playerPL -= loss; refreshPL(); betLog.push({ q: current + 1, odds: loss, outcome: -loss }); saveState();
        document.getElementById("verification-message").textContent = loss > 0 ? `❌ Wrong code. You lose €${loss.toFixed(2)} this round.` : "❌ Wrong code. Enter odds to risk an amount."
      }
    }

    function checkAnswer() {
      const input = document.getElementById("answer").value.trim()
      answers[current] = input; saveState();
      const correct = (questions[current].a || "").toLowerCase()
      attemptsByQuestion[current] = (attemptsByQuestion[current] || 0) + 1; saveState();
      if (input.toLowerCase() === correct || input.toLowerCase() === MASTER_ANSWER.toLowerCase()) {
        if (attemptsByQuestion[current] === 1) firstTryCorrect[current] = true;
        current++; saveState();
        if (current >= questions.length) { showBonus(); return }
        showQuestion()
      } else {
        if (attemptsByQuestion[current] === 1) firstTryCorrect[current] = false;
        saveState();
        document.getElementById("message").textContent = "❌ Wrong answer, try again!"
      }
    }

    function goBack() { if (current > 0) current--; showQuestion() }

    function endGame() {
      const attempts = betLog.length
      const wins = betLog.filter(r => r.outcome > 0).length
      const bets = betLog.map(r => r.odds).filter(n => n > 0)
      const totalStake = bets.reduce((s, n) => s + n, 0)
      document.getElementById("end-score").textContent = `Overall score: ${wins} / ${attempts} correct`
      const firstCount = firstTryCorrect.filter(v => v === true).length
      document.getElementById("end-firsttry").textContent = `First-try correct answers: ${firstCount} / ${questions.length}`
      document.getElementById("end-pl").textContent = `Final P/L: ${formatMoney(playerPL)}`
      document.getElementById("end-bets-total").textContent = bets.length ? `Total staked: €${totalStake.toFixed(2)}` : ""
      document.getElementById("end-bets").textContent = bets.length ? `Your bet sizes: ${bets.map(n => "€" + n.toFixed(2)).join(", ")}` : ""
      drawBetChart(bets)
      document.getElementById("question-stage").classList.add("hidden")
      document.getElementById("bonus-screen").classList.add("hidden")
      document.getElementById("end-screen").classList.remove("hidden")
      document.getElementById("sticky-title").style.display = "block"
      document.getElementById("title-question").textContent = FINAL_TITLE
      document.getElementById("pl-footer").classList.add("hidden")
      document.getElementById("skyline").style.display = "block";
      resetState();
    }

    function showBonus() {
      document.getElementById("question-stage").classList.add("hidden");
      document.getElementById("bonus-screen").classList.remove("hidden");
      document.getElementById("sticky-title").style.display = "block";
      document.getElementById("title-question").textContent = "Bonus";
      document.getElementById("rgb-r").value = "";
      document.getElementById("rgb-g").value = "";
      document.getElementById("rgb-b").value = "";
      document.getElementById("bonus-msg").textContent = "";
      setupRGBInputs();
      saveState();
    }

    function verifyBonus() {
      const r = Number(document.getElementById("rgb-r").value);
      const g = Number(document.getElementById("rgb-g").value);
      const b = Number(document.getElementById("rgb-b").value);
      const msg = document.getElementById("bonus-msg");
      if ([r, g, b].some(v => Number.isNaN(v) || v < 0 || v > 255)) {
        msg.textContent = "Please enter three numbers between 0 and 255.";
        return;
      }
      const ok = (r === BONUS_RGB[0] && g === BONUS_RGB[1] && b === BONUS_RGB[2]);
      if (ok) { msg.textContent = "✅ Correcto!"; endGame(); }
      else { msg.textContent = "❌ Nopes."; }
    }
    function setupRGBInputs() {
      const ids = ['rgb-r', 'rgb-g', 'rgb-b'];
      const els = ids.map(id => document.getElementById(id));
      els.forEach((el, i) => {
        el.addEventListener('input', e => {
          e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(0, 2);
          if (e.target.value.length >= 2) {
            const next = els[i + 1];
            if (next) { next.focus(); next.select(); }
          }
        });
        el.addEventListener('keydown', e => {
          if (e.key === 'Backspace' && e.target.value === '') {
            const prev = els[i - 1];
            if (prev) { prev.focus(); }
          }
        });
      });
    }

    document.addEventListener("keyup", function (e) {
      if (e.key === "Enter") {
        const verifyVisible = !document.getElementById("verification").classList.contains("hidden");
        const mainVisible = document.getElementById("main-question").style.display !== "none";
        const bonusVisible = !document.getElementById("bonus-screen").classList.contains("hidden");
        if (verifyVisible) checkVerification();
        else if (mainVisible) checkAnswer();
        else if (bonusVisible) verifyBonus();
      }
    })

    function drawBetChart(bets) {
      const canvas = document.getElementById("bet-chart")
      if (!canvas) return
      const ctx = canvas.getContext("2d")
      const W = canvas.width, H = canvas.height
      ctx.clearRect(0, 0, W, H)
      if (!bets || bets.length === 0) { ctx.font = "16px 'Special Elite', monospace"; ctx.fillStyle = "#444"; ctx.textAlign = "center"; ctx.fillText("No bets placed", W / 2, H / 2); return }
      const pad = { left: 44, right: 8, top: 10, bottom: 28 }
      const x0 = pad.left, y0 = H - pad.bottom
      const x1 = W - pad.right, y1 = pad.top
      const innerW = x1 - x0, innerH = y0 - y1
      const maxY = Math.max(1, Math.max(...bets) * 1.15)
      ctx.strokeStyle = "#333"; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(x0, y0); ctx.lineTo(x0, y1); ctx.moveTo(x0, y0); ctx.lineTo(x1, y0); ctx.stroke()
      ctx.font = "12px 'Special Elite', monospace"; ctx.fillStyle = "#333"; ctx.textAlign = "right"; ctx.textBaseline = "middle"; ctx.strokeStyle = "rgba(0,0,0,0.08)"
      for (let i = 0; i <= 4; i++) { const v = (maxY / 4) * i; const y = y0 - (v / maxY) * innerH; ctx.beginPath(); ctx.moveTo(x0, y); ctx.lineTo(x1, y); ctx.stroke(); ctx.fillText("€" + v.toFixed(0), x0 - 6, y) }
      const stepX = bets.length === 1 ? innerW : innerW / (bets.length - 1)
      ctx.strokeStyle = "#222"; ctx.lineWidth = 2; ctx.beginPath()
      bets.forEach((b, i) => { const x = x0 + stepX * i; const y = y0 - (b / maxY) * innerH; if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y) })
      ctx.stroke()
      ctx.fillStyle = "#222"
      bets.forEach((b, i) => { const x = x0 + stepX * i; const y = y0 - (b / maxY) * innerH; ctx.beginPath(); ctx.arc(x, y, 3, 0, Math.PI * 2); ctx.fill() })
      ctx.textAlign = "center"; ctx.textBaseline = "top"
      for (let i = 0; i < bets.length; i++) { const x = x0 + stepX * i; ctx.fillText(String(i + 1), x, y0 + 6) }
    }

    document.getElementById("intro-info-pop").classList.add("hidden");
    document.getElementById("intro-info-btn").onclick = toggleIntroInfo;
    document.getElementById("skyline").style.display = "block";

    const pdfModal = document.getElementById('pdf-modal');
    const pdfIframe = document.getElementById('pdf-iframe');
    const pdfViewport = document.getElementById('pdf-viewport');
    const pdfHint = document.getElementById('pdf-hint');
    const pdfClose = document.getElementById('pdf-close');

    const zoomInput = document.getElementById('zoom-input');
    const zoomRange = document.getElementById('zoom-range');
    const zoomInBtn = document.getElementById('zoom-in');
    const zoomOutBtn = document.getElementById('zoom-out');

    let zoom = 100;

    function applyZoom() {
      const s = zoom / 100;
      pdfIframe.style.transform = `scale(${s})`;
      pdfIframe.style.width = (100 / s) + '%';
      pdfIframe.style.height = (100 / s) + '%';
      zoomInput.value = Math.round(zoom);
      zoomRange.value = Math.round(zoom);
    }

    function setZoom(p) {
      zoom = Math.min(300, Math.max(30, p));
      applyZoom();
    }

    function openPdf() {
      const isPhone = window.innerWidth <= 430;
      const defaultPercent = isPhone ? 62 : 90;
      setZoom(defaultPercent);
      pdfIframe.src = 'kozbeszerzesi.pdf#page=1&zoom=page-fit';
      pdfModal.style.display = 'flex';
    }
    function closePdf() {
      pdfModal.style.display = 'none';
      pdfIframe.src = '';
    }

    zoomInBtn.addEventListener('click', () => setZoom(zoom + 10));
    zoomOutBtn.addEventListener('click', () => setZoom(zoom - 10));
    zoomRange.addEventListener('input', (e) => setZoom(Number(e.target.value)));
    zoomInput.addEventListener('change', (e) => setZoom(Number(e.target.value)));

    pdfHint.addEventListener('click', openPdf);
    pdfHint.addEventListener('keydown', function (e) {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openPdf(); }
    });
    pdfClose.addEventListener('click', closePdf);
    pdfModal.addEventListener('click', function (e) {
      if (e.target === pdfModal) closePdf();
    });
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && pdfModal.style.display === 'flex') closePdf();
    });

    document.getElementById('go-start').addEventListener('click', goToStart);

    document.addEventListener('DOMContentLoaded', () => {
      const s = loadState();
      if (s && s.started) {
        const wants = confirm('Ha gyökér vagy és véletlen frissítetted akkor menj rá, hogy "OK"!');
        if (wants) startGame(true);
        else resetState();
      }
    });

    window.addEventListener('beforeunload', () => { saveState(); });
  </script>
</body>

</html>
